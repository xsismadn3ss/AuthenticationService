name: Deploy Spring Boot API

env:
  DB_URL: ${{ secrets.DB_URL }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
  JWT_EXPIRATION: ${{ secrets.JWT_EXPIRATION }}

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'  # Puedes usar 'zulu' o 'adopt' si prefieres otra distribuci√≥n
        java-version: '21'

    - name: Check Java version
      run: java -version

    - name: Make gradlew executable
      run: chmod +x ./gradlew
  
    - name: Build JAR
      run: ./gradlew build # o mvn package si usas Maven

    - name: Rename JAR
      run: |
        mkdir -p build/libs/final
        JAR_FILE=$(ls build/libs/*.jar | grep -v plain | head -n 1)
        cp "$JAR_FILE" build/libs/final/app.jar

    - name: Copy JAR to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: build/libs/final/app.jar
        target: /opt/spring-auth-api/

    - name: Restart Spring Boot service
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        envs: DB_URL,DB_USER,DB_PASSWORD,JWT_SECRET_KEY,JWT_EXPIRATION
        script: |
          echo "Usando DB_URL=$DB_URL"
          export DB_URL=$DB_URL
          export DB_USER=$DB_USER
          export DB_PASSWORD=$DB_PASSWORD
          export JWT_SECRET_KEY=$JWT_SECRET_KEY
          export JWT_EXPIRATION=$JWT_EXPIRATION
          sudo systemctl restart spring-auth-api.service

